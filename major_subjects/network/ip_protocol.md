
# IP는 인터넷층의 프로토콜
- Internet layer는 주로 IP와 ICMP라는 2개의 프로토콜로 구성되어 있다.
- IPv4와 IPv6라는 IP 프로토콜을 사용한다.
## IP는 OSI 참조 모델의 제3층에 해당
- IP는 OSI 참조 모델의 네트워크층에 해당한다.
- 네트워크 층의 역할은 종점 노드간의 통신을 실현하는 것이다.
## 네트워크층과 데이터 링크층의 관계
- 데이터 링크층은 직접 연결된 기기간의 통신을 제공한다.
- 네트워크층인 IP는 직접 연결되어 있지 않은 네트워크 간의 전송을 실현한다.
- 따라서 네트워크층과 데이터링크층이 모두 필요하다.

# IP
- IP의 역할은 크게 IP 주소, 라우팅, IP 패킷의 분할 처리와 재구축 처리로 나눌 수 있다.
## IP 주소는 네트워크층의 주소
- 네트워크층인 IP에서 사용하는 IP 주소는 네트워크에 연결되어 있는 모든 호스트 중에서 통신할 상대를 식별할 때 사용한다.
- TCP/IP에서 통신하는 모든 호스트와 라우터는 반드시 IP 주소가 설정되어야 한다.
- IP 주소의 형식은 데이터 링크의 종류에 구애받지 않는다. 따라서 네트워크층은 데이터 링크층의 성질을 추상화하는 기능이 있다.
## 경로 제어(라우팅)
- 수신처 IP 주소를 가진 호스트까지 패킷을 전달하기 위한 기능이다.
### 최종 수신처의 호스트까지 패킷을 배송하는 과정
  - TCP/IP에서 IP 패킷이 네트워크 1구간을 뛰는 것을 'hop'이라고 하며 이 1구간을 1hop이라고 한다.
  - IP 경로 제어는 'hop by hop 라우팅'이란 방식을 사용한다. 즉, 1홉별로 그 다음 루트가 정해져서 패킷이 전송된다.
  - hop by hop 라우팅에서 라우터나 호스트는 IP 패킷에 다음 전송처가 되는 라우터나 호스트를 지시하는 것이다.
  - 각 홉별로 각각의 라우터가 수신처 IP 패킷을 조사하여 다음 라우터로 IP 패킷의 전송 처리를 하고, 그것을 반복함으로써 최종 수신처의 호스트까지 패킷이 도달하는 것이다.
  - Routing Table : 모든 호스트나 라우터는 수신처 호스트까지 패킷을 보낼 때에 사용하는 경로 제어표(라우팅 테이블) 정보를 가진다. 테이블에는 IP 패킷을 다음에 어떤 라우터에게 보낼지 기록되어 있고 IP 패킷은 이것을 따라 각 링크로 보내진다.
## 데이터 링크의 추상화
- IP는 서로 다른 데이터 링크 사이에서 통신이 가능하게 해주는 프로토콜이다.
- IP는 데이터 링크 각각의 고유한 특징들을 추상화한다.
- 데이터 링크별로 다른 특징 중 하나로 최대 전송 단위(MTU)가 있다.
- 패킷 길이보다 MTU의 값이 작은 경우, 분할 처리(조각화)를 통해 IP 패킷을 여러 개의 작은 패킷으로 분할하여 처리한다. 이 때문에 IP 상위층에서 보면, 중간에 통과하는 데이터 링크의 MTU와 관계없이 원본의 패킷을 전달받을 수 있다.
## IP는 connectionless
- IP는 connectionless이기 때문에 패킷을 송신하기 전에 통신 상대와의 커넥션을 확립하지 않는다.
- 따라서 수신처 호스트의 전원이 꺼져있거나 존재 하지 않는 경우에도 패킷 전송이 가능하고 패킷의 간략화와 전송의 고속화가 가능하다.


# IP 주소 기초 지식
- TCP/IP로 통신할 때, IP 주소를 사용하여 호스트나 라우터를 식별한다.
## IP 주소란
- IP 주소는 32비트의 정수 수치로 나타낸다
- TCP/IP로 통신할 경우 IP 주소를 각각의 호스트에 할당해야 한다.
- IP 주소는 컴퓨터 내부에서 이진수로 처리되는데 사람이 이해하기 쉽도록 32비트의 IP 주소를 8비트씩 4그룹으로 나누어 그 경계에 피리어드(.)을 넣은 후 십진수로 표현할 수 있다.
<img width="300" alt="image" src="https://user-images.githubusercontent.com/110087065/211355118-eccb271c-e068-424e-8cd4-47eddfbbd1c6.png">

- IP 주소로 표현할 수 있는 조합 가능한 수는 2^32개 즉,4,294,967,296개이다.
- IP 주소는 NIC 별로 할당하고, 한 NIC에 여러 개의 IP 주소를 할당할 수 있기 때문에 약 43억개의 IP 주소는 부족하다.
## IP 주소의 네트워크부와 호스트부
- IP 주소는 '네트워크부'와 '호스트부'로 나눌 수 있다.
- '네트워크부'의 값은 데이터 링크의 세그먼트별로 할당된다.
- 동일한 세그먼트로 연결되어 있는 호스트에는 모두 동일한 네트워크 주소를 설정해야 한다.
- IP 주소의 '호스트부'는 동일한 세그먼트 내에서 겹치지 않는 값을 할당한다.
- 이렇게 네트워크와 호스트 주소를 설정하면 연결되어 있는 네트워크 전체에서 동일한 IP 주소를 갖고 있는 컴퓨터는 1대밖에 없도록 설정하여 유니크한 IP 주소를 설정할 수 있다.
- IP 패킷이 중간 라우터로 전송될 때, 수신처 IP 주소의 네트워크부가 이용된다. 호스트부를 보지 않아도 어떤 세그먼트 안에 있느 호스트인지 식별 가능하기 때문이다.
## IP 주소의 클래스
<img width="300" alt="image" src="https://user-images.githubusercontent.com/110087065/211358164-94311701-9ddc-4b17-b5f3-f38bb402107a.png">

- IP 주소 할당 초기에는 IP 주소를 앞에서 4비트씩 끊은 비트열을 조합하여 클래스 A, B, C, D, E라는 5개의 클래스로 분류했다.
## Broadcast address
- 브로드캐스트 주소는 동일한 링크에 연결된 모든 호스트에게 패킷을 송신할 때 사용한다.
- IP 주소의 호스트부 비트를 모드 1로 만들면 브로드캐스트 주소이다.
- 예를 들어, 172.20.0.0/16의 브로드캐스트 주소는 172.20.255.255이다.
### local broadcast
- 자신이 속해 있는 링크 안의 브로드캐스트
### direct broadcast
- 다른 IP 네트워크에 대한 브로드캐스트에는 다이렉트 브로드캐스트 주소를 설정해야 한다.
## IP Multicast
- 멀티캐스트의 기능은 필요로 하는 그룹에게만 패킷을 송신하는 것이다.
### IP Multicast와 주소
- IP 멀티캐스트는 클래스 D의 IP 주소를 사용하기 때문에 맨 앞의 4비트가 1110이면 멀티캐스트 주소로 식별한다.
- 나머지 28비트가 멀티캐스트의 대상이 되는 그룹 번호이다.
- IP 멀티캐스트의 주소로 224.0.0.0부터 239.255.255.255까지 사용 가능하다.
- 224.0.0.0부터 224.0.0.255까지는 경로 제어가 되지 않고 동일한 링크 안에서도 멀티캐스트가 되며, 이외의 주소는 전체 네트워크의 그룹 멤버에게 전달된다.
## 서브넷 마스크
### 서브 네트워크와 서브넷 마스크
- 서브넷 마스크는 식별자를 도입해서 IP 주소에 대한 네트워크 아이디와 호스트 아이디를 구분하기 위해 사용된다.
- 서브 네트워크의 도입으로 IP 주소는 'IP 주소'와 '서브넷 마스크'(서브 네트워크 마스크, 넷마스크) 2개의 식별자로 표현 가능하다.
- 서브넷 마스크는 32비트로 된 수치로, IP 주소의 네트워크를 나타내는 비트에 대응하는 부분의 비트는 1이 되고, 호스트부를 나타내는 비트에 대응하는 부분의 비트는 0이 된다.
<img width="600" alt="image" src="https://user-images.githubusercontent.com/110087065/211368671-4947134f-735a-43ba-bc9f-f01c9cdfe884.png">

- 서브넷 마스크와 IP 주소를 AND 연산하여 네트워크 주소를 구할 수 있다.
## CIDR, VLSM
- CIDR, VLSM은 IPv4의 주소 부족 문제의 일시적인 해결책이다.
### CIDR
- 클래스에 구애받지 않는 조직 간 경로 제어를 의미한다.
- 조직 간 라우팅 프로토콜인 BGP가 CIDR을 지원함으로써 클래스에 구애받지 않고 IP 주소를 배포할 수 있게 되었다.
- CIDR을 통해 주소 공간을 효과적으로 이용할 수 있게 되었고, 경로 정보를 집약 및 압축할 수 있게 되었다.
### VLSM
- 가변 길이 서브넷 마스크인 VLSM은 조직 내의 부서마다 서브넷 마스크와 길이를 바꿀 수 있도록 해주는 장치이다.
- 조직 내의 라우팅 프로토콜을 RIP2, OSPF로 변경하여 실현되었다.
## Global address, Private address
- 10.0.0.0 – 10.255.255.255, 172.16.0.0 – 172.31.255.255, 192.168.0.0 – 192.168.255.255 의 범위 안에 포함되는 주소를 프라이빗 주소라 하고, 범위 밖의 주소를 글로벌 주소라 한다.
- 초기 프라이빗 주소는 인터넷의 연결을 고려하지 않은 네트워크에서 이용하였으나 NAT 기술로 프라이빗 주소를 할당한 네트워크상의 호스트에서 글로벌 주소를 할당한 인터넷상의 호스트와 통신 가능하다.
- 기업이나 학교 내에서 프라이빗 IP 주소를 설정하고 인터넷과 연결하는 라우터는 글로벌 IP 주소를 설정하는 것이 일반화 되어 있는데, 프라이빗 IP 주소가 설정된 호스트가 인터넷과 통신하고 싶은 경우 NAT를 거쳐 통신을 하게 된다.

# 경로 제어(라우팅)
- 호스트나 라우터는 경로 제어표를 바탕으로 패킷을 송신할 곳을 결정한 후 패킷을 보낸다.
- 경로 제어표를 작성하는 방법으로는 '정적 경로 제어'와 '동적 경로 제어'가 존재한다.
## IP 주소와 경로 제어(라우팅)
- 경로 제어표에느 네트워크 주소와 다음에 전송할 라우터의 주소가 존재한다.
- IP 패킷을 송신할 때 IP 패킷의 수신처 주소를 조사하여 경로 제어표와 일치하는 네트워크 주소를 검색하고 대응하는 라우터에게 패킷을 보낸다.
### 디폴트 라우트
- 디폴트 라우트는 0.0.0.0/0 또는 default로 기술한다.
- 모든 네트워크, 서브넷 정보를 경로 제어표에 넣는 건 낭비이므로 디폴트 라우트를 이용한다.
- 경로 제어표에 등록되어 있는 어떤 주소와도 일치하지 않는 경우에 사용하는 경우를 말한다.
### 호스트 라우트
- 호스트 라우트는 IP주소/32로 기술한다.
- IP 주소의 모든 비트를 사용하여 경로를 제어한다.
- 호스트 라우트를 사용하면 IP 주소의 네트워크부가 아니라 네트워크 인터페이스에 설정된 IP 주소를 바탕으로 경로 제어를 한다.
### 루프백 주소
- 루프백 주소는 127.0.0.1로 기술한다.
- 루프백 주소는 같은 컴퓨터 내부의 프로그램 사이에 통신을 하고 싶은 경우에 이용한다.
- 이 주소를 이용하면 패킷은 네트워크로 나가지 않는다.
## 경로 제어표의 집약(Aggregation)
- 네트워크 주소의 비트 패턴을 생각하여 계층적으로 배치하면 여러 개의 서브 네트워크로 구성되어 있다고 하더라도 외부적으로는 대표하는 하나의 네트워크 주소로 경로 제어를 할 수 있다.
- 네트워크를 잘 구축하여 경로 제어 정보를 집약하며 경로 제어표를 작게 만들 수 있다.
- 경로 제어표가 작으면 관리에 메모리 공간이나 CPU 파워의 성능 저하를 막을 수 있다.

# IP의 분할 처리와 재구축 처리
## 데이터 링크에 따라 MTU(최대 전송 속도)가 다르다.
- 데이터 링크는 각각의 목적별로 만들어져 각각의 MTU의 크기가 정해져 있기 때문에 MTU가 다르다.
## IP 데이터그램의 분할 처리와 재구축 처리
- 네트워크에 데이터그램을 보내려고할 때 그 크기대로 전송할 수 없을 때 분할 처리가 수행된다.
- 분할된 IP 데이터그램을 원래의 IP 데이터그램으로 되돌릴 때 재구축 처리가 수행된다.
- 재구축 처리는 최종 수신처 호스트에서만 이루어진다.
- 중간 라우터는 분할 처리는 수행하지만 재구축 처리는 하지 않는다.
## 경로 MTU 탐색
### 분할 처리의 단점
- IP 분할 처리는 라우터에게 부하가 된다.
- 분할된 단편 하나를 분실했을 경우, 원래 IP 데이터그램 전체가 손상된다.
- 이러한 단점을 보완하기 위한 기술이 MTU 탐색이다.
### 경로 MTU
- 송신처 호스트에서 수신처 호스트까지 분할 처리를 할 필요가 없는 최대 MTU
### 경로 MTU 탐색
- 경로 MTU 탐색은 경로 MTU를 발견하고 송신처 호스트에서 경로 MTU의 크기로 데이터를 분할한 후 송신하는 방법이다.


# IPv4 헤더
<img width="600" alt="image" src="https://user-images.githubusercontent.com/110087065/211481790-672575c8-18c2-4229-b171-a3136e390796.png">

- IP 헤더는 IP 패킷의 앞부분에 위치하며 IP 주소를 비롯한 각종 제어정보를 담고 있다. IPv4 헤더는 고정 부분 20바이트와 가변 부분 0~40바이트로 구성되어 있다. 옵션을 지정하지 않았을 때의 최소 크기는 20바이트이다.
## 버전
- IP의 버전을 나타내는 영역으로 IPv4의 경우 4(0100)이다.
## 헤더 길이
- 헤더 길이(Header Length)는 4바이트를 기본 단위로 헤더의 길이를 규정하는 영역이다. IPv4에서는 헤더 길이가 가변이므로 이를 규정하는 영역이 필요하다. 기본값은 5로서, 최소 크기는 20 바이트이고, 옵션 영역을 사용하면 60바이트까지 확장할 수 있다.
## DS
- DS(Differentiated Service, 차등 서비스)는 IP 패킷 전송 시 우선순위와 혼잡 알림을 위한 8비트의 영역이다.
## 전체 길이
- 전체 길이(Total Length)는 헤더와 데이터를 합한 IP 패킷 전체 길이를 바이트 단위로 나타낸다. 최댓값은 65,535바이트이다.
## 식별자
- 식별자(Identification)는 IP 패킷을 식별하기 위해 사용된다. 이 영역의 값을 참조하면 어느 원본 패킷으로부터 분할되었는지를 알 수 있다.
## 플래그
- 플래그(Flags)는 패킷의 분할 여부에 대한 정보를 나타내는 3비트의 영역이다. 첫 번째 비트는 예비용을 항상 0으로 설정하며, 두 번째 비트는 DF(Don't Fragment), 세 번째 비트는 MF(More Fragment)이다. DF는 데이터를 조각화할 것인지 판단하는 역할을 하며, 0이면 분할이 가능하고 1이면 분할하지 말라는 의미이다. MF는 조각이 더 있는지 판단하는 역할을 하며, 0이면 마지막 조각이라는 뜻이고 1이면 아직 수신되지 않은 조각이 있다는 의미이다.
## 단편 오프셋
- 단편 오프셋(Fragment Offset)은 분할된 패킷을 재조립할 수 있도록 원래 위치를 알려주는 영역으로, 바이트를 8로 나눈 값을 사용한다.
## TTL
- 수신지에 도착하지 못한 패킷이 네트워크에 남으면 결과적으로 네트워크의 자원을 심각하게 잠식할 수 있다. TTL(Time to Live, 패킷 수명)은 이를 방지하는 옵션으로, 라우터를 지날 때마다 TTL 값을 하나씩 감소시키고 값이 0이 된 패킷을 받으면 폐기하도록 한다. 폐기된 패킷을 수신하면 전송지에 이를 알리는 메시지를 보낸다.
## 프로토콜 유형
- 프로토콜 유형(Protocol Type)은 데이터에 어떤 상위 계층 프로토콜이 포함되어 있는지를 나타낸다.
## 헤더 체크섬
- 헤더 체크섬(Header Checksum)은 네트워크를 통해 패킷이 전송될 때 발생한 오류를 검출하기 위해 사용하는 영역이다. 데이터 전체가 아닌 헤드의 오류만 검출하며, 오류가 검출되면 복구하지 않고 폐기한다.
## 전송지 주소
- 전송지 주소(Source Address)는 패킷을 전송하는 호스트의 주소를 나타내는 영역이다.
## 수신지 주소
- 수신지 주소(Destination Address)는 패킷을 수신하는 호스트의 주소를 나타내는 영역이다.


# IPv6
- IPv4 주소의 고갈 문제를 근본적으로 해결하기 위해 표준화하여 이용하기 시작한 인터넷 프로토콜이다.
## IPv6의 특징
- IP 주소의 확대와 경로 제어표의 집약
  - 주소 구조에 적합하도록 IP 주소를 계획적으로 배포하고 경로 제어표가 커지지 않도록 한다.
- 퍼포먼스 향상
  - 헤더 길이 고정, 체크섬 생략하는 등의 헤더의 구조 간소화
  - 경로 MTU 탐색을 이용하여 송신처의 호스트가 분할 처리를 한다.
- 플러그, 플레이를 필수로 한다.
  - DHCP가 없는 환경이라도 IP 주소를 자동으로 할당
- 인증 기능이나 암호화 기능을 채택
  - IPsec 제공
- 멀티캐스트, Mobile IP 기능을 IPv6의 확장 기능으로 정의
  - IPv4에서 운용하기 어려웠던 멀티캐스트나 Mobile IP도 쉽게 운용 가능
## IPv6에서의 IP 주소 표기 방법
- IPv6에서의 IP 주소의 길이는 128비트이다.
- 128비트의 IP 주소를 16비트마다 콜론으로 끊고 16진수로 표기한다.
- 0이 연속적으로 나오는 경우 0을 생략하고 콜론을 연속으로 표기한다.
EX) 1080:0:0:0:0:8:800:200C:417A -> 1080::8:800:200C:417A
## 글로벌 유니캐스트 주소
- 인터넷과의 통신에서 가장 일반적으로 사용하는 고유한 IPv6의 주소
## 링크 로컬 유니캐스트 주소
- '동일한 데이터 링크 내에서 고유하게 정해진 주소'로 라우터를 거치지 않는 동일 링크 내의 통신에서 사용된다.
## 유니크 로컬 주소
- 인터넷과 통신하지 않는 경우에 사용하는 주소이다.
- 보안 강화를 위해 NAT나 게이트웨이를 경유하여 네트워크에 연결 가능하다.
## IPv6의 분할 처리
- 고속 인터넷 실현을 위해 IPv6에서 분할 처리는 송신하는 호스트에서만 일어나며, 라우터는 분할 처리를 하지 않는다.


# IP 관련 기술
## DNS(Domain Name System)
- 영문/한글 주소를 IP 네트워크에서 찾아갈 수 있는 IP로 변환해 준다.
- EX) www.naver.com 이라는 문자로 이루어진 주소를 IP 주소로 변경하여 목적지로 찾아가게 만들어주는 시스템
## ARP(Address Resolution Protocol)
- 네트워크 계층 주소와 링크 계층 주소 사이의 변환을 담당하는 프로토콜
- ARP는 네트워크 계층 주소(IP 주소)를 물리 주소(MAC 주소)로 변환하기 위해 사용된다. 
## ICMP(Internet Control Mesaage Protocol)
- ICMP는 인터넷 환경에서 오류에 관한 처리를 지원하는 용도로 사용된다.
- TCP/IP 기반 통신망에서 전송 과정에 문제가 발생 시, 라우터에 의해 ICMP 메시지가 발생하여 패킷 송신 호스트에게 전달된다.
## DHCP(Dynamic Host Configuration Protocol)
- 윈도 NT를 기본으로 하는 근거리망(LAN)에 접속하는 컴퓨터에 IP 주소를 할당하는 마이크로소프트 사의 기술.
- 컴퓨터가 네트워크에 접속하면 DHCP 서버가 자신의 목록에서 IP 주소를 선택하여 할당해주는 것을 말한다.
## NAT(Network Address Translation)
- 공인 IP주소를 사설 IP주소로 바꿔주는 데 사용하는 통신망의 주소 변환기이다.
- 인터넷의 공인 IP주소를 절약할 수 있고, 인터넷이란 공공망과 연결되는 사용자들의 고유한 사설망을 침입자들로부터 보호할 수 있다
## IP 터널링
- 인터넷상의 가상 사설 통신망(VPN)에서 데이터를 IP 패킷화할 때, 각 통신망 환경에서 사용되고 있는 통신망 통신 규약을 IP 통신 규약으로 캡슐화함과 동시에 안전성을 높이기 위한 기술.
- 대표적인 것으로 점 대 점 터널링 통신 규약(PPTP)과 L2F(layer 2 forwarding)가 있다. 이 2개를 융합시킨 것이 계층 2 터널링 통신 규약(L2TP)
- 예를 들면, 본사의 통신망과 지사의 통신망이 각각 망간 패킷 교환(IPX)이라 부르는 통신망 통신 규약을 사용하고 있다면, 본사와 지사를 연결하는 인터넷을 사용하기 위해 각각의 인터넷 출구에서 IP의 통신 규약으로 캡슐화한다.
- 내부 통신망에서 본 출구의 라우터는 IPX 라우터로 보이고 인터넷에서 보면 IP 라우터로 보인다.


